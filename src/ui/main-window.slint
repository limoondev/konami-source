// Konami Client - Main Window
// Revolutionary Minecraft Launcher with premium UI

import { Theme, KonamiTheme } from "theme/theme.slint";
import { KonamiCard, GlassCard } from "components/card.slint";
import { KonamiButton, IconButton } from "components/button.slint";
import { Sidebar, SidebarItem } from "components/sidebar.slint";
import { AnimatedProgress, CircularProgress } from "components/progress.slint";

import { HomePage, NewsItem, QuickAction } from "pages/home-page.slint";
import { ModsPage, ModInfo, ModFilter } from "pages/mods-page.slint";
import { ProfilesPage, ProfileInfo, CreateProfileDialog } from "pages/profiles-page.slint";
import { SettingsPage, LauncherSettings } from "pages/settings-page.slint";
import { SkinsPage, SkinInfo, CapeInfo } from "pages/skins-page.slint";

// User account info
export struct AccountInfo {
    username: string,
    uuid: string,
    avatar-url: string,
    is-logged-in: bool,
    account-type: string, // "microsoft", "offline"
}

// Download progress
export struct DownloadProgress {
    is-downloading: bool,
    current-file: string,
    current-progress: float,
    total-progress: float,
    download-speed: string,
    eta: string,
    files-completed: int,
    files-total: int,
}

// Game status
export struct GameStatus {
    is-running: bool,
    current-version: string,
    memory-usage: string,
    uptime: string,
}

// Main window component
export component MainWindow inherits Window {
    title: "Konami Client";
    min-width: 1200px;
    min-height: 720px;
    default-font-family: "Inter";
    background: Theme.background;
    
    // Properties
    in property <string> current-page: "home";
    in property <AccountInfo> account;
    in property <DownloadProgress> download-progress;
    in property <GameStatus> game-status;
    in property <[ProfileInfo]> profiles;
    in property <[ModInfo]> installed-mods;
    in property <[ModInfo]> available-mods;
    in property <[SkinInfo]> skins;
    in property <[CapeInfo]> capes;
    in property <[NewsItem]> news;
    in property <LauncherSettings> settings;
    in property <bool> is-launching: false;
    in property <float> launch-progress: 0;
    in property <string> selected-profile-id;
    in property <string> current-version: "1.21.4";
    
    // Callbacks
    callback navigate(string);
    callback login();
    callback logout();
    callback launch-game();
    callback stop-game();
    callback minimize-window();
    callback maximize-window();
    callback close-window();
    callback open-settings();
    callback refresh-data();
    
    // Content
    VerticalLayout {
        // Custom title bar
        TitleBar {
            account: account;
            minimize-clicked => { minimize-window(); }
            maximize-clicked => { maximize-window(); }
            close-clicked => { close-window(); }
            login-clicked => { login(); }
            logout-clicked => { logout(); }
        }
        
        // Main content area
        HorizontalLayout {
            // Sidebar navigation
            Rectangle {
                width: 72px;
                background: Theme.surface;
                
                VerticalLayout {
                    padding-top: 16px;
                    padding-bottom: 16px;
                    spacing: 8px;
                    alignment: start;
                    
                    // Logo
                    Rectangle {
                        height: 56px;
                        
                        Rectangle {
                            x: (parent.width - 48px) / 2;
                            y: (parent.height - 48px) / 2;
                            width: 48px;
                            height: 48px;
                            border-radius: 12px;
                            background: @linear-gradient(135deg, Theme.primary, Theme.accent);
                            
                            Text {
                                text: "K";
                                font-size: 28px;
                                font-weight: 800;
                                color: white;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                    
                    Rectangle { height: 16px; }
                    
                    // Navigation items
                    NavItem {
                        icon: "\u{f015}";
                        tooltip: "Home";
                        is-active: current-page == "home";
                        clicked => { navigate("home"); }
                    }
                    
                    NavItem {
                        icon: "\u{f11b}";
                        tooltip: "Profiles";
                        is-active: current-page == "profiles";
                        clicked => { navigate("profiles"); }
                    }
                    
                    NavItem {
                        icon: "\u{f12e}";
                        tooltip: "Mods";
                        is-active: current-page == "mods";
                        clicked => { navigate("mods"); }
                    }
                    
                    NavItem {
                        icon: "\u{f007}";
                        tooltip: "Skins";
                        is-active: current-page == "skins";
                        clicked => { navigate("skins"); }
                    }
                    
                    Rectangle { vertical-stretch: 1; }
                    
                    // Download indicator
                    if download-progress.is-downloading: Rectangle {
                        height: 48px;
                        
                        CircularProgress {
                            x: (parent.width - 36px) / 2;
                            y: (parent.height - 36px) / 2;
                            width: 36px;
                            height: 36px;
                            progress: download-progress.total-progress;
                        }
                    }
                    
                    NavItem {
                        icon: "\u{f013}";
                        tooltip: "Settings";
                        is-active: current-page == "settings";
                        clicked => { navigate("settings"); }
                    }
                }
            }
            
            // Divider
            Rectangle {
                width: 1px;
                background: Theme.border;
            }
            
            // Page content
            Rectangle {
                horizontal-stretch: 1;
                clip: true;
                
                // Home page
                if current-page == "home": HomePage {
                    account: account;
                    selected-profile: profiles.length > 0 ? profiles[0].name : "No profile";
                    current-version: current-version;
                    is-launching: is-launching;
                    launch-progress: launch-progress;
                    news: news;
                    game-running: game-status.is-running;
                    
                    launch-clicked => { launch-game(); }
                    stop-clicked => { stop-game(); }
                }
                
                // Profiles page
                if current-page == "profiles": ProfilesPage {
                    profiles: profiles;
                    selected-profile-id: selected-profile-id;
                }
                
                // Mods page
                if current-page == "mods": ModsPage {
                    installed-mods: installed-mods;
                    search-results: available-mods;
                }
                
                // Skins page
                if current-page == "skins": SkinsPage {
                    skins: skins;
                    capes: capes;
                    active-skin: skins.length > 0 ? skins[0] : {
                        id: "default",
                        name: "Steve",
                        model-type: "classic",
                        is-active: true,
                    };
                }
                
                // Settings page
                if current-page == "settings": SettingsPage {
                    settings: settings;
                }
            }
        }
        
        // Status bar
        StatusBar {
            download-progress: download-progress;
            game-status: game-status;
            current-version: current-version;
        }
    }
}

// Custom title bar
component TitleBar inherits Rectangle {
    in property <AccountInfo> account;
    
    callback minimize-clicked();
    callback maximize-clicked();
    callback close-clicked();
    callback login-clicked();
    callback logout-clicked();
    
    height: 40px;
    background: Theme.surface;
    
    HorizontalLayout {
        padding-left: 16px;
        padding-right: 8px;
        alignment: space-between;
        
        // Drag area / Title
        Rectangle {
            horizontal-stretch: 1;
            
            Text {
                text: "Konami Client";
                font-size: 13px;
                font-weight: 600;
                color: Theme.text-secondary;
                vertical-alignment: center;
            }
        }
        
        // Account section
        HorizontalLayout {
            spacing: 12px;
            
            if account.is-logged-in: HorizontalLayout {
                spacing: 8px;
                
                // Avatar
                Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 6px;
                    background: Theme.primary.with-alpha(0.2);
                    
                    Text {
                        text: "\u{f007}";
                        font-size: 14px;
                        color: Theme.primary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                Text {
                    text: account.username;
                    font-size: 13px;
                    font-weight: 500;
                    color: Theme.text-primary;
                    vertical-alignment: center;
                }
                
                Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 6px;
                    background: logout-touch.has-hover ? Theme.surface-variant : transparent;
                    
                    logout-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { logout-clicked(); }
                    }
                    
                    Text {
                        text: "\u{f2f5}";
                        font-size: 12px;
                        color: Theme.text-tertiary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
            
            if !account.is-logged-in: Rectangle {
                width: 80px;
                height: 28px;
                border-radius: 6px;
                background: login-touch.has-hover ? Theme.primary-hover : Theme.primary;
                
                login-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => { login-clicked(); }
                }
                
                Text {
                    text: "Login";
                    font-size: 12px;
                    font-weight: 500;
                    color: Theme.text-on-primary;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            Rectangle { width: 8px; }
            
            // Window controls
            HorizontalLayout {
                spacing: 4px;
                
                // Minimize
                Rectangle {
                    width: 32px;
                    height: 28px;
                    border-radius: 4px;
                    background: min-touch.has-hover ? Theme.surface-variant : transparent;
                    
                    min-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { minimize-clicked(); }
                    }
                    
                    Text {
                        text: "\u{f2d1}";
                        font-size: 10px;
                        color: Theme.text-secondary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                // Maximize
                Rectangle {
                    width: 32px;
                    height: 28px;
                    border-radius: 4px;
                    background: max-touch.has-hover ? Theme.surface-variant : transparent;
                    
                    max-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { maximize-clicked(); }
                    }
                    
                    Text {
                        text: "\u{f2d0}";
                        font-size: 10px;
                        color: Theme.text-secondary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                // Close
                Rectangle {
                    width: 32px;
                    height: 28px;
                    border-radius: 4px;
                    background: close-touch.has-hover ? Theme.error : transparent;
                    
                    close-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { close-clicked(); }
                    }
                    
                    Text {
                        text: "\u{f00d}";
                        font-size: 12px;
                        color: close-touch.has-hover ? white : Theme.text-secondary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}

// Navigation item
component NavItem inherits Rectangle {
    in property <string> icon;
    in property <string> tooltip;
    in property <bool> is-active;
    in property <bool> has-notification: false;
    
    callback clicked();
    
    height: 48px;
    
    Rectangle {
        x: (parent.width - 48px) / 2;
        y: 0;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: is-active ? Theme.primary.with-alpha(0.15) : 
                    touch.has-hover ? Theme.surface-variant : transparent;
        
        animate background { duration: 150ms; }
        
        touch := TouchArea {
            mouse-cursor: pointer;
            clicked => { root.clicked(); }
        }
        
        Text {
            text: icon;
            font-size: 20px;
            color: is-active ? Theme.primary : Theme.text-secondary;
            horizontal-alignment: center;
            vertical-alignment: center;
            
            animate color { duration: 150ms; }
        }
        
        // Active indicator
        if is-active: Rectangle {
            x: 0;
            y: (parent.height - 24px) / 2;
            width: 3px;
            height: 24px;
            border-radius: 0 2px 2px 0;
            background: Theme.primary;
        }
        
        // Notification dot
        if has-notification: Rectangle {
            x: parent.width - 14px;
            y: 6px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background: Theme.error;
            border-width: 2px;
            border-color: Theme.surface;
        }
    }
}

// Status bar
component StatusBar inherits Rectangle {
    in property <DownloadProgress> download-progress;
    in property <GameStatus> game-status;
    in property <string> current-version;
    
    height: 32px;
    background: Theme.surface;
    border-width: 1px 0 0 0;
    border-color: Theme.border;
    
    HorizontalLayout {
        padding-left: 16px;
        padding-right: 16px;
        alignment: space-between;
        
        // Left side - Download info
        HorizontalLayout {
            spacing: 16px;
            
            if download-progress.is-downloading: HorizontalLayout {
                spacing: 8px;
                
                // Progress indicator
                Rectangle {
                    width: 100px;
                    height: 4px;
                    border-radius: 2px;
                    background: Theme.surface-variant;
                    
                    Rectangle {
                        width: download-progress.total-progress * parent.width;
                        height: 100%;
                        border-radius: 2px;
                        background: Theme.primary;
                        
                        animate width { duration: 200ms; }
                    }
                }
                
                Text {
                    text: download-progress.download-speed + " - " + download-progress.eta;
                    font-size: 11px;
                    color: Theme.text-secondary;
                    vertical-alignment: center;
                }
            }
            
            if game-status.is-running: HorizontalLayout {
                spacing: 6px;
                
                // Running indicator
                Rectangle {
                    width: 8px;
                    height: 8px;
                    border-radius: 4px;
                    background: Theme.success;
                    
                    // Pulse animation
                    animate opacity {
                        duration: 1000ms;
                        iteration-count: -1;
                    }
                }
                
                Text {
                    text: "Minecraft running - " + game-status.memory-usage + " RAM";
                    font-size: 11px;
                    color: Theme.text-secondary;
                    vertical-alignment: center;
                }
            }
        }
        
        // Right side - Version info
        HorizontalLayout {
            spacing: 16px;
            
            Text {
                text: "Konami Client v1.0.0";
                font-size: 11px;
                color: Theme.text-tertiary;
                vertical-alignment: center;
            }
            
            Rectangle {
                width: 1px;
                height: 16px;
                background: Theme.border;
            }
            
            Text {
                text: "MC " + current-version;
                font-size: 11px;
                color: Theme.text-tertiary;
                vertical-alignment: center;
            }
        }
    }
}
