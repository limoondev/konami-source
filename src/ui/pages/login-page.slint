// =============================================================================
// Konami Client - Login Page
// Premium authentication experience with Microsoft OAuth
// =============================================================================

import { KonamiTheme, ThemeColors, Animations, Spacing } from "../theme/theme.slint";
import { KonamiButton, IconButton } from "../components/button.slint";
import { GlassCard, AnimatedCard } from "../components/card.slint";
import { AnimatedProgress, CircularProgress } from "../components/progress.slint";

// =============================================================================
// Login States
// =============================================================================

export enum LoginState {
    Idle,
    WaitingForBrowser,
    Authenticating,
    FetchingProfile,
    Success,
    Error
}

// =============================================================================
// Animated Background Component
// =============================================================================

component AnimatedBackground inherits Rectangle {
    background: @linear-gradient(135deg, 
        ThemeColors.background-primary 0%, 
        ThemeColors.background-secondary 50%,
        ThemeColors.background-tertiary 100%);
    
    // Floating orb 1
    Rectangle {
        x: parent.width * 0.1 + Math.sin(animation-tick() / 2s * 360deg) * 50px;
        y: parent.height * 0.2 + Math.cos(animation-tick() / 3s * 360deg) * 30px;
        width: 300px;
        height: 300px;
        border-radius: 150px;
        background: ThemeColors.accent-primary;
        opacity: 0.1;
    }
    
    // Floating orb 2
    Rectangle {
        x: parent.width * 0.7 + Math.cos(animation-tick() / 2.5s * 360deg) * 40px;
        y: parent.height * 0.6 + Math.sin(animation-tick() / 3.5s * 360deg) * 50px;
        width: 400px;
        height: 400px;
        border-radius: 200px;
        background: ThemeColors.accent-secondary;
        opacity: 0.08;
    }
    
    // Floating orb 3
    Rectangle {
        x: parent.width * 0.4 + Math.sin(animation-tick() / 4s * 360deg) * 60px;
        y: parent.height * 0.8 + Math.cos(animation-tick() / 2s * 360deg) * 40px;
        width: 250px;
        height: 250px;
        border-radius: 125px;
        background: ThemeColors.accent-tertiary;
        opacity: 0.06;
    }
}

// =============================================================================
// Logo Component
// =============================================================================

component KonamiLogo inherits VerticalLayout {
    alignment: center;
    spacing: Spacing.md;
    
    // Animated logo container
    Rectangle {
        width: 120px;
        height: 120px;
        border-radius: 30px;
        background: @linear-gradient(135deg, 
            ThemeColors.accent-primary 0%, 
            ThemeColors.accent-secondary 100%);
        
        drop-shadow-blur: 30px;
        drop-shadow-color: ThemeColors.accent-primary.transparentize(0.6);
        drop-shadow-offset-y: 10px;
        
        // Inner glow animation
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 80px + Math.sin(animation-tick() / 1s * 360deg) * 5px;
            height: 80px + Math.sin(animation-tick() / 1s * 360deg) * 5px;
            border-radius: 20px;
            background: white.transparentize(0.9);
        }
        
        // K letter
        Text {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            text: "K";
            font-size: 60px;
            font-weight: 900;
            color: white;
        }
    }
    
    // Title
    Text {
        text: "KONAMI CLIENT";
        font-size: 28px;
        font-weight: 800;
        color: ThemeColors.text-primary;
        letter-spacing: 4px;
        horizontal-alignment: center;
    }
    
    // Subtitle
    Text {
        text: "Premium Minecraft Experience";
        font-size: 14px;
        font-weight: 500;
        color: ThemeColors.text-tertiary;
        horizontal-alignment: center;
    }
}

// =============================================================================
// Auth Status Component
// =============================================================================

component AuthStatus inherits Rectangle {
    in property <LoginState> state: LoginState.Idle;
    in property <string> status-text: "";
    in property <float> progress: 0.0;
    
    width: 100%;
    height: state != LoginState.Idle ? 120px : 0px;
    opacity: state != LoginState.Idle ? 1.0 : 0.0;
    
    animate height { duration: Animations.duration-normal; easing: ease-out; }
    animate opacity { duration: Animations.duration-normal; }
    
    VerticalLayout {
        alignment: center;
        spacing: Spacing.md;
        padding: Spacing.lg;
        
        if state == LoginState.WaitingForBrowser || state == LoginState.Authenticating || state == LoginState.FetchingProfile: HorizontalLayout {
            alignment: center;
            spacing: Spacing.md;
            
            CircularProgress {
                width: 24px;
                height: 24px;
                progress: root.progress;
                indeterminate: state == LoginState.WaitingForBrowser;
            }
            
            Text {
                text: root.status-text;
                font-size: 14px;
                color: ThemeColors.text-secondary;
                vertical-alignment: center;
            }
        }
        
        if state == LoginState.Success: HorizontalLayout {
            alignment: center;
            spacing: Spacing.sm;
            
            Rectangle {
                width: 24px;
                height: 24px;
                border-radius: 12px;
                background: ThemeColors.status-success;
                
                Text {
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    text: "âœ“";
                    font-size: 14px;
                    color: white;
                }
            }
            
            Text {
                text: root.status-text;
                font-size: 14px;
                color: ThemeColors.status-success;
                vertical-alignment: center;
            }
        }
        
        if state == LoginState.Error: HorizontalLayout {
            alignment: center;
            spacing: Spacing.sm;
            
            Rectangle {
                width: 24px;
                height: 24px;
                border-radius: 12px;
                background: ThemeColors.status-error;
                
                Text {
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    text: "!";
                    font-size: 14px;
                    font-weight: 700;
                    color: white;
                }
            }
            
            Text {
                text: root.status-text;
                font-size: 14px;
                color: ThemeColors.status-error;
                vertical-alignment: center;
            }
        }
        
        // Progress bar for multi-step auth
        if state == LoginState.Authenticating || state == LoginState.FetchingProfile: AnimatedProgress {
            width: 100%;
            height: 4px;
            progress: root.progress;
        }
    }
}

// =============================================================================
// Feature Highlight Component
// =============================================================================

component FeatureHighlight inherits HorizontalLayout {
    in property <string> icon: "";
    in property <string> title: "";
    in property <string> description: "";
    
    spacing: Spacing.md;
    
    Rectangle {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: ThemeColors.accent-primary.transparentize(0.9);
        
        Text {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            text: root.icon;
            font-size: 18px;
            color: ThemeColors.accent-primary;
        }
    }
    
    VerticalLayout {
        alignment: center;
        spacing: 2px;
        
        Text {
            text: root.title;
            font-size: 13px;
            font-weight: 600;
            color: ThemeColors.text-primary;
        }
        
        Text {
            text: root.description;
            font-size: 11px;
            color: ThemeColors.text-tertiary;
        }
    }
}

// =============================================================================
// Main Login Page
// =============================================================================

export component LoginPage inherits Rectangle {
    in property <LoginState> login-state: LoginState.Idle;
    in property <string> status-text: "Ready to sign in";
    in property <float> auth-progress: 0.0;
    in property <string> error-message: "";
    
    callback login-with-microsoft();
    callback login-offline(string);
    callback cancel-login();
    
    AnimatedBackground { }
    
    // Main content
    HorizontalLayout {
        alignment: center;
        
        VerticalLayout {
            alignment: center;
            
            GlassCard {
                width: 420px;
                blur-intensity: 20px;
                
                VerticalLayout {
                    padding: Spacing.xxl;
                    spacing: Spacing.xl;
                    
                    // Logo section
                    KonamiLogo { }
                    
                    // Divider
                    Rectangle {
                        width: 100%;
                        height: 1px;
                        background: ThemeColors.border-subtle;
                    }
                    
                    // Auth status
                    AuthStatus {
                        state: root.login-state;
                        status-text: root.status-text;
                        progress: root.auth-progress;
                    }
                    
                    // Login buttons
                    VerticalLayout {
                        spacing: Spacing.md;
                        
                        // Microsoft login button
                        KonamiButton {
                            width: 100%;
                            text: login-state == LoginState.Idle ? "Sign in with Microsoft" : "Signing in...";
                            variant: primary;
                            enabled: login-state == LoginState.Idle;
                            
                            clicked => {
                                root.login-with-microsoft();
                            }
                        }
                        
                        // Cancel button (shown during auth)
                        if login-state != LoginState.Idle && login-state != LoginState.Success: KonamiButton {
                            width: 100%;
                            text: "Cancel";
                            variant: ghost;
                            
                            clicked => {
                                root.cancel-login();
                            }
                        }
                    }
                    
                    // Features section
                    VerticalLayout {
                        spacing: Spacing.md;
                        
                        Text {
                            text: "Why Konami Client?";
                            font-size: 12px;
                            font-weight: 600;
                            color: ThemeColors.text-tertiary;
                            horizontal-alignment: center;
                        }
                        
                        FeatureHighlight {
                            icon: "âš¡";
                            title: "Lightning Fast";
                            description: "Optimized downloads and instant launches";
                        }
                        
                        FeatureHighlight {
                            icon: "ðŸŽ¨";
                            title: "Beautiful Design";
                            description: "Premium UI with smooth animations";
                        }
                        
                        FeatureHighlight {
                            icon: "ðŸ”’";
                            title: "Secure";
                            description: "Encrypted token storage and secure auth";
                        }
                    }
                    
                    // Version info
                    Text {
                        text: "Konami Client v1.0.0";
                        font-size: 11px;
                        color: ThemeColors.text-quaternary;
                        horizontal-alignment: center;
                    }
                }
            }
        }
    }
}
